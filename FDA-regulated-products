'''
The openFDA food enforcement reports API returns data from the FDA Recall Enterprise System (RES),
a database that contains information on recall event information submitted to FDA.
Currently, this data covers publicly releasable records from 2004-present. The data is updated weekly.
The procedures followed to input recall information into RES when FDA learns of a recall event
are outlined in Chapter 7 of FDAâ€™s Regulatory Procedure Manual The Regulatory Procedures Manual is a reference manual for FDA personnel.
It provides FDA personnel with information on internal procedures to be used in processing domestic and import regulatory and enforcement matters.
'''

import requests
import pandas as pd
import json
from sqlalchemy import create_engine
import pyodbc


r = requests.get('https://api.fda.gov/food/enforcement.json?limit=100') #pulling the first 100 rows from the website endpoint 

data = open('enforcement.json', 'wb').write(r.content) # saving the json file locally

data = json.load(open("enforcement.json")) #opening the json file 

df = pd.DataFrame(data["results"]) #saving the json file as pandas dataframe

df['openfda']= df['openfda'].astype(str) #without this step the "openfda" column would be treated as "dict" type, causing the table to not be uploaded to SQL

engine = create_engine('mssql+pyodbc://LAPTOP-NAAAGCHR\SQLEXPRESS/DS udemy training?driver=SQL server?Trusted_Connection = yes') #specyfing the SQL path

conn = engine.connect() #creating the connection with SQL

tosql = df.to_sql('results', con=engine,if_exists="append",index=False,chunksize=1000) #uploading the file in SQL Server

conn.close()


#todo:  
# - automate the process with AWS
    - store the file locally (in tmp or temp folder?)
    -cloudwatch -> lambda -> s3




